{"version":3,"sources":["dropdown.js"],"names":["define","$","$window","window","include","zippedData","datum","i","elem","idProperty","strategy","length","value","dropdownViews","document","on","e","id","originalEvent","keepTextCompleteDropdown","each","key","view","deactivate","commands","SKIP_DEFAULT","KEY_UP","KEY_DOWN","KEY_ENTER","KEY_PAGEUP","KEY_PAGEDOWN","KEY_ESCAPE","Dropdown","element","completer","option","this","$el","createElement","_data","$inputEl","listPosition","setPosition","height","self","_i","name","_bindEvents","extend","$parent","appendTo","addClass","dropdownClassName","attr","_oid","css","display","left","position","zIndex","prototype","footer","header","maxCount","placement","shown","data","className","destroy","off","clear","remove","render","contentsHtml","_buildContents","unzippedData","map","d","removeAttr","_renderHeader","_renderFooter","_renderContents","_fitToBottom","_fitToRight","_activateIndexedItem","_setScroll","noResultsMessage","_renderNoResultsMessage","pos","add","parents","top","scrollTop","scrollLeft","_applyPlacement","html","_index","_$header","_$footer","_$noResultsMessage","activate","show","fire","hide","removeClass","isUp","keyCode","ctrlKey","isDown","isEnter","altKey","metaKey","shiftKey","completeOnSpace","isPageup","isPagedown","isEscape","proxy","_onClick","_onMouseover","_onKeydown","target","preventDefault","hasClass","closest","parseInt","select","setTimeout","type","focus","command","isFunction","onKeydown","_defaultKeydown","_up","_down","_enter","_pageup","_pagedown","_getActiveElement","threshold","innerHeight","children","outerHeight","find","$activeEl","itemTop","itemHeight","visibleHeight","visibleTop","index","push","template","term","prependTo","before","append","windowScrollBottom","$iframe","offset","tolerance","rightEdgeOffset","lastOffset","width","maxLeft","indexOf","bottom","parent","lineHeight","right","fn","textcomplete"],"mappings":"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","file":"../dropdown.js","sourcesContent":["define([\n  \"skylark-jquery\",\n  \"./textcomplete\"\n],function ($) {  \n  'use strict';\n\n  var $window = $(window);\n\n  var include = function (zippedData, datum) {\n    var i, elem;\n    var idProperty = datum.strategy.idProperty\n    for (i = 0; i < zippedData.length; i++) {\n      elem = zippedData[i];\n      if (elem.strategy !== datum.strategy) continue;\n      if (idProperty) {\n        if (elem.value[idProperty] === datum.value[idProperty]) return true;\n      } else {\n        if (elem.value === datum.value) return true;\n      }\n    }\n    return false;\n  };\n\n  var dropdownViews = {};\n  $(document).on('click', function (e) {\n    var id = e.originalEvent && e.originalEvent.keepTextCompleteDropdown;\n    $.each(dropdownViews, function (key, view) {\n      if (key !== id) { view.deactivate(); }\n    });\n  });\n\n  var commands = {\n    SKIP_DEFAULT: 0,\n    KEY_UP: 1,\n    KEY_DOWN: 2,\n    KEY_ENTER: 3,\n    KEY_PAGEUP: 4,\n    KEY_PAGEDOWN: 5,\n    KEY_ESCAPE: 6\n  };\n\n  // Dropdown view\n  // =============\n\n  // Construct Dropdown object.\n  //\n  // element - Textarea or contenteditable element.\n  function Dropdown(element, completer, option) {\n    this.$el       = Dropdown.createElement(option);\n    this.completer = completer;\n    this.id        = completer.id + 'dropdown';\n    this._data     = []; // zipped data.\n    this.$inputEl  = $(element);\n    this.option    = option;\n\n    // Override setPosition method.\n    if (option.listPosition) { this.setPosition = option.listPosition; }\n    if (option.height) { this.$el.height(option.height); }\n    var self = this;\n    $.each(['maxCount', 'placement', 'footer', 'header', 'noResultsMessage', 'className'], function (_i, name) {\n      if (option[name] != null) { self[name] = option[name]; }\n    });\n    this._bindEvents(element);\n    dropdownViews[this.id] = this;\n  }\n\n  $.extend(Dropdown, {\n    // Class methods\n    // -------------\n\n    createElement: function (option) {\n      var $parent = option.appendTo;\n      if (!($parent instanceof $)) { $parent = $($parent); }\n      var $el = $('<ul></ul>')\n        .addClass(option.dropdownClassName)\n        .attr('id', 'textcomplete-dropdown-' + option._oid)\n        .css({\n          display: 'none',\n          left: 0,\n          position: 'absolute',\n          zIndex: option.zIndex\n        })\n        .appendTo($parent);\n      return $el;\n    }\n  });\n\n  $.extend(Dropdown.prototype, {\n    // Public properties\n    // -----------------\n\n    $el:       null,  // jQuery object of ul.dropdown-menu element.\n    $inputEl:  null,  // jQuery object of target textarea.\n    completer: null,\n    footer:    null,\n    header:    null,\n    id:        null,\n    maxCount:  null,\n    placement: '',\n    shown:     false,\n    data:      [],     // Shown zipped data.\n    className: '',\n\n    // Public methods\n    // --------------\n\n    destroy: function () {\n      // Don't remove $el because it may be shared by several textcompletes.\n      this.deactivate();\n\n      this.$el.off('.' + this.id);\n      this.$inputEl.off('.' + this.id);\n      this.clear();\n      this.$el.remove();\n      this.$el = this.$inputEl = this.completer = null;\n      delete dropdownViews[this.id]\n    },\n\n    render: function (zippedData) {\n      var contentsHtml = this._buildContents(zippedData);\n      var unzippedData = $.map(zippedData, function (d) { return d.value; });\n      if (zippedData.length) {\n        var strategy = zippedData[0].strategy;\n        if (strategy.id) {\n          this.$el.attr('data-strategy', strategy.id);\n        } else {\n          this.$el.removeAttr('data-strategy');\n        }\n        this._renderHeader(unzippedData);\n        this._renderFooter(unzippedData);\n        if (contentsHtml) {\n          this._renderContents(contentsHtml);\n          this._fitToBottom();\n          this._fitToRight();\n          this._activateIndexedItem();\n        }\n        this._setScroll();\n      } else if (this.noResultsMessage) {\n        this._renderNoResultsMessage(unzippedData);\n      } else if (this.shown) {\n        this.deactivate();\n      }\n    },\n\n    setPosition: function (pos) {\n      // Make the dropdown fixed if the input is also fixed\n      // This can't be done during init, as textcomplete may be used on multiple elements on the same page\n      // Because the same dropdown is reused behind the scenes, we need to recheck every time the dropdown is showed\n      var position = 'absolute';\n      // Check if input or one of its parents has positioning we need to care about\n      this.$inputEl.add(this.$inputEl.parents()).each(function() {\n        if($(this).css('position') === 'absolute') // The element has absolute positioning, so it's all OK\n          return false;\n        if($(this).css('position') === 'fixed') {\n          pos.top -= $window.scrollTop();\n          pos.left -= $window.scrollLeft();\n          position = 'fixed';\n          return false;\n        }\n      });\n      this.$el.css(this._applyPlacement(pos));\n      this.$el.css({ position: position }); // Update positioning\n\n      return this;\n    },\n\n    clear: function () {\n      this.$el.html('');\n      this.data = [];\n      this._index = 0;\n      this._$header = this._$footer = this._$noResultsMessage = null;\n    },\n\n    activate: function () {\n      if (!this.shown) {\n        this.clear();\n        this.$el.show();\n        if (this.className) { this.$el.addClass(this.className); }\n        this.completer.fire('textComplete:show');\n        this.shown = true;\n      }\n      return this;\n    },\n\n    deactivate: function () {\n      if (this.shown) {\n        this.$el.hide();\n        if (this.className) { this.$el.removeClass(this.className); }\n        this.completer.fire('textComplete:hide');\n        this.shown = false;\n      }\n      return this;\n    },\n\n    isUp: function (e) {\n      return e.keyCode === 38 || (e.ctrlKey && e.keyCode === 80);  // UP, Ctrl-P\n    },\n\n    isDown: function (e) {\n      return e.keyCode === 40 || (e.ctrlKey && e.keyCode === 78);  // DOWN, Ctrl-N\n    },\n\n    isEnter: function (e) {\n      var modifiers = e.ctrlKey || e.altKey || e.metaKey || e.shiftKey;\n      return !modifiers && (e.keyCode === 13 || e.keyCode === 9 || (this.option.completeOnSpace === true && e.keyCode === 32))  // ENTER, TAB\n    },\n\n    isPageup: function (e) {\n      return e.keyCode === 33;  // PAGEUP\n    },\n\n    isPagedown: function (e) {\n      return e.keyCode === 34;  // PAGEDOWN\n    },\n\n    isEscape: function (e) {\n      return e.keyCode === 27;  // ESCAPE\n    },\n\n    // Private properties\n    // ------------------\n\n    _data:    null,  // Currently shown zipped data.\n    _index:   null,\n    _$header: null,\n    _$noResultsMessage: null,\n    _$footer: null,\n\n    // Private methods\n    // ---------------\n\n    _bindEvents: function () {\n      this.$el.on('mousedown.' + this.id, '.textcomplete-item', $.proxy(this._onClick, this));\n      this.$el.on('touchstart.' + this.id, '.textcomplete-item', $.proxy(this._onClick, this));\n      this.$el.on('mouseover.' + this.id, '.textcomplete-item', $.proxy(this._onMouseover, this));\n      this.$inputEl.on('keydown.' + this.id, $.proxy(this._onKeydown, this));\n    },\n\n    _onClick: function (e) {\n      var $el = $(e.target);\n      e.preventDefault();\n      e.originalEvent.keepTextCompleteDropdown = this.id;\n      if (!$el.hasClass('textcomplete-item')) {\n        $el = $el.closest('.textcomplete-item');\n      }\n      var datum = this.data[parseInt($el.data('index'), 10)];\n      this.completer.select(datum.value, datum.strategy, e);\n      var self = this;\n      // Deactive at next tick to allow other event handlers to know whether\n      // the dropdown has been shown or not.\n      setTimeout(function () {\n        self.deactivate();\n        if (e.type === 'touchstart') {\n          self.$inputEl.focus();\n        }\n      }, 0);\n    },\n\n    // Activate hovered item.\n    _onMouseover: function (e) {\n      var $el = $(e.target);\n      e.preventDefault();\n      if (!$el.hasClass('textcomplete-item')) {\n        $el = $el.closest('.textcomplete-item');\n      }\n      this._index = parseInt($el.data('index'), 10);\n      this._activateIndexedItem();\n    },\n\n    _onKeydown: function (e) {\n      if (!this.shown) { return; }\n\n      var command;\n\n      if ($.isFunction(this.option.onKeydown)) {\n        command = this.option.onKeydown(e, commands);\n      }\n\n      if (command == null) {\n        command = this._defaultKeydown(e);\n      }\n\n      switch (command) {\n        case commands.KEY_UP:\n          e.preventDefault();\n          this._up();\n          break;\n        case commands.KEY_DOWN:\n          e.preventDefault();\n          this._down();\n          break;\n        case commands.KEY_ENTER:\n          e.preventDefault();\n          this._enter(e);\n          break;\n        case commands.KEY_PAGEUP:\n          e.preventDefault();\n          this._pageup();\n          break;\n        case commands.KEY_PAGEDOWN:\n          e.preventDefault();\n          this._pagedown();\n          break;\n        case commands.KEY_ESCAPE:\n          e.preventDefault();\n          this.deactivate();\n          break;\n      }\n    },\n\n    _defaultKeydown: function (e) {\n      if (this.isUp(e)) {\n        return commands.KEY_UP;\n      } else if (this.isDown(e)) {\n        return commands.KEY_DOWN;\n      } else if (this.isEnter(e)) {\n        return commands.KEY_ENTER;\n      } else if (this.isPageup(e)) {\n        return commands.KEY_PAGEUP;\n      } else if (this.isPagedown(e)) {\n        return commands.KEY_PAGEDOWN;\n      } else if (this.isEscape(e)) {\n        return commands.KEY_ESCAPE;\n      }\n    },\n\n    _up: function () {\n      if (this._index === 0) {\n        this._index = this.data.length - 1;\n      } else {\n        this._index -= 1;\n      }\n      this._activateIndexedItem();\n      this._setScroll();\n    },\n\n    _down: function () {\n      if (this._index === this.data.length - 1) {\n        this._index = 0;\n      } else {\n        this._index += 1;\n      }\n      this._activateIndexedItem();\n      this._setScroll();\n    },\n\n    _enter: function (e) {\n      var datum = this.data[parseInt(this._getActiveElement().data('index'), 10)];\n      this.completer.select(datum.value, datum.strategy, e);\n      this.deactivate();\n    },\n\n    _pageup: function () {\n      var target = 0;\n      var threshold = this._getActiveElement().position().top - this.$el.innerHeight();\n      this.$el.children().each(function (i) {\n        if ($(this).position().top + $(this).outerHeight() > threshold) {\n          target = i;\n          return false;\n        }\n      });\n      this._index = target;\n      this._activateIndexedItem();\n      this._setScroll();\n    },\n\n    _pagedown: function () {\n      var target = this.data.length - 1;\n      var threshold = this._getActiveElement().position().top + this.$el.innerHeight();\n      this.$el.children().each(function (i) {\n        if ($(this).position().top > threshold) {\n          target = i;\n          return false\n        }\n      });\n      this._index = target;\n      this._activateIndexedItem();\n      this._setScroll();\n    },\n\n    _activateIndexedItem: function () {\n      this.$el.find('.textcomplete-item.active').removeClass('active');\n      this._getActiveElement().addClass('active');\n    },\n\n    _getActiveElement: function () {\n      return this.$el.children('.textcomplete-item:nth(' + this._index + ')');\n    },\n\n    _setScroll: function () {\n      var $activeEl = this._getActiveElement();\n      var itemTop = $activeEl.position().top;\n      var itemHeight = $activeEl.outerHeight();\n      var visibleHeight = this.$el.innerHeight();\n      var visibleTop = this.$el.scrollTop();\n      if (this._index === 0 || this._index == this.data.length - 1 || itemTop < 0) {\n        this.$el.scrollTop(itemTop + visibleTop);\n      } else if (itemTop + itemHeight > visibleHeight) {\n        this.$el.scrollTop(itemTop + itemHeight + visibleTop - visibleHeight);\n      }\n    },\n\n    _buildContents: function (zippedData) {\n      var datum, i, index;\n      var html = '';\n      for (i = 0; i < zippedData.length; i++) {\n        if (this.data.length === this.maxCount) break;\n        datum = zippedData[i];\n        if (include(this.data, datum)) { continue; }\n        index = this.data.length;\n        this.data.push(datum);\n        html += '<li class=\"textcomplete-item\" data-index=\"' + index + '\"><a>';\n        html +=   datum.strategy.template(datum.value, datum.term);\n        html += '</a></li>';\n      }\n      return html;\n    },\n\n    _renderHeader: function (unzippedData) {\n      if (this.header) {\n        if (!this._$header) {\n          this._$header = $('<li class=\"textcomplete-header\"></li>').prependTo(this.$el);\n        }\n        var html = $.isFunction(this.header) ? this.header(unzippedData) : this.header;\n        this._$header.html(html);\n      }\n    },\n\n    _renderFooter: function (unzippedData) {\n      if (this.footer) {\n        if (!this._$footer) {\n          this._$footer = $('<li class=\"textcomplete-footer\"></li>').appendTo(this.$el);\n        }\n        var html = $.isFunction(this.footer) ? this.footer(unzippedData) : this.footer;\n        this._$footer.html(html);\n      }\n    },\n\n    _renderNoResultsMessage: function (unzippedData) {\n      if (this.noResultsMessage) {\n        if (!this._$noResultsMessage) {\n          this._$noResultsMessage = $('<li class=\"textcomplete-no-results-message\"></li>').appendTo(this.$el);\n        }\n        var html = $.isFunction(this.noResultsMessage) ? this.noResultsMessage(unzippedData) : this.noResultsMessage;\n        this._$noResultsMessage.html(html);\n      }\n    },\n\n    _renderContents: function (html) {\n      if (this._$footer) {\n        this._$footer.before(html);\n      } else {\n        this.$el.append(html);\n      }\n    },\n\n    _fitToBottom: function() {\n      var windowScrollBottom = $window.scrollTop() + $window.height();\n      var height = this.$el.height();\n      if ((this.$el.position().top + height) > windowScrollBottom) {\n        // only do this if we are not in an iframe\n        if (!this.completer.$iframe) {\n          this.$el.offset({top: windowScrollBottom - height});\n        }\n      }\n    },\n\n    _fitToRight: function() {\n      // We don't know how wide our content is until the browser positions us, and at that point it clips us\n      // to the document width so we don't know if we would have overrun it. As a heuristic to avoid that clipping\n      // (which makes our elements wrap onto the next line and corrupt the next item), if we're close to the right\n      // edge, move left. We don't know how far to move left, so just keep nudging a bit.\n      var tolerance = this.option.rightEdgeOffset; // pixels. Make wider than vertical scrollbar because we might not be able to use that space.\n      var lastOffset = this.$el.offset().left, offset;\n      var width = this.$el.width();\n      var maxLeft = $window.width() - tolerance;\n      while (lastOffset + width > maxLeft) {\n        this.$el.offset({left: lastOffset - tolerance});\n        offset = this.$el.offset().left;\n        if (offset >= lastOffset) { break; }\n        lastOffset = offset;\n      }\n    },\n\n    _applyPlacement: function (position) {\n      // If the 'placement' option set to 'top', move the position above the element.\n      if (this.placement.indexOf('top') !== -1) {\n        // Overwrite the position object to set the 'bottom' property instead of the top.\n        position = {\n          top: 'auto',\n          bottom: this.$el.parent().height() - position.top + position.lineHeight,\n          left: position.left\n        };\n      } else {\n        position.bottom = 'auto';\n        delete position.lineHeight;\n      }\n      if (this.placement.indexOf('absleft') !== -1) {\n        position.left = 0;\n      } else if (this.placement.indexOf('absright') !== -1) {\n        position.right = 0;\n        position.left = 'auto';\n      }\n      return position;\n    }\n  });\n\n  $.fn.textcomplete.Dropdown = Dropdown;\n  $.extend($.fn.textcomplete, commands);\n\n});\n"]}